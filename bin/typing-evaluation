#!/usr/bin/env node
var os = require('os');
var path = require('path');
var logger = require('loge');
var cluster = require('cluster');
var db = require('../db');

var yargs = require('yargs')
  .describe({
    hostname: 'hostname to listen on',
    port: 'port to listen on',
    forks: 'number of workers to spawn',

    help: 'print this help message',
    verbose: 'print extra output',
    version: 'print version',
  })
  .boolean(['help', 'verbose', 'version'])
  .default({
    port: parseInt(process.env.PORT) || 80,
    forks: os.cpus().length,
  });

var argv = yargs.argv;
logger.level = argv.verbose ? 'debug' : 'info';

if (argv.help) {
  yargs.showHelp();
}
else if (argv.version) {
  console.log(require('../package').version);
}
else if (cluster.isWorker) {
  require('../server').listen(argv.port, argv.hostname);
}
else {
  db.createDatabaseIfNotExists(function(err, exists) {
    if (err) throw err;

    var migrations_dirpath = path.join(__dirname, '..', 'migrations');
    db.executePatches('_migrations', migrations_dirpath, function(err) {
      if (err) throw err;

      logger.info('Cluster master forking %d initial workers.', argv.forks);
      for (var i = 0; i < argv.forks; i++) {
        cluster.fork();
      }
      cluster.on('disconnect', function(worker) {
        logger.error('Worker[%s] died. Forking a new worker.', worker.id);
        cluster.fork();
      });
    });
  });
}
